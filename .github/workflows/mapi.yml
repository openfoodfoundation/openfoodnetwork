name: 'Mayhem for API'
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
    - uses: actions/checkout@v2
    - run: docker/build
    - run: docker-compose up --detach
    - run: until curl -f -s http://localhost:3000; do echo "waiting for api server"; sleep 1; done
    - run: docker-compose exec -T db psql postgresql://ofn:f00d@localhost:5432/open_food_network_dev --command="update spree_users set spree_api_key='testing' where login='ofn@example.com'"

    # Run Mayhem for API
    - name: Run Mayhem for API
      uses: ForAllSecure/mapi-action@v1
      continue-on-error: true
      with:
        mapi-token: ${{ secrets.MAPI_TOKEN }}
        api-url: http://localhost:3000
        api-spec: swagger/v0/swagger.yaml
        target: mayhemheroes/openfoodnetwork
        duration: 1min
        sarif-report: mapi.sarif
        html-report: mapi.html
        run-args: |
          --header-auth
          X-Spree-Token: testing

    # Archive HTML report
    - name: Archive Mayhem for API report
      uses: actions/upload-artifact@v2
      with:
        name: mapi-report
        path: mapi.html

    # Upload SARIF file (only available on public repos or github enterprise)
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: mapi.sarif
